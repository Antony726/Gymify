<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üîß User Repair Tool - Gymify</title>
  <style>
    body {
      margin: 0;
      font-family: monospace;
      background: #0d1117;
      color: #fff;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: #161b22;
      padding: 20px;
      border-radius: 12px;
    }
    h2 {
      color: #66fcf1;
    }
    button {
      background: #238636;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      cursor: pointer;
      font-weight: 600;
      margin: 10px 5px;
      font-family: Arial;
    }
    button:hover {
      background: #2ea043;
    }
    button:disabled {
      background: #444;
      cursor: not-allowed;
    }
    .log {
      background: #000;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      max-height: 500px;
      overflow-y: auto;
      font-size: 13px;
    }
    .log div {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #666;
      padding-left: 10px;
    }
    .success {
      border-left-color: #238636 !important;
      color: #7ee787;
    }
    .error {
      border-left-color: #da3633 !important;
      color: #ff7b72;
    }
    .warning {
      border-left-color: #ff9800 !important;
      color: #ffb74d;
    }
    .info {
      border-left-color: #1f6feb !important;
      color: #58a6ff;
    }
    .section {
      background: #2a2a2a;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    .user-card {
      background: #1a1a1a;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      border-left: 3px solid #666;
    }
    .user-card.missing {
      border-left-color: #da3633;
    }
    .user-card.ok {
      border-left-color: #238636;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üîß User Profile Repair Tool</h2>
    <p>This tool checks all users and repairs missing profiles/usernames</p>
    
    <div class="section">
      <h3 style="color: #66fcf1;">Step 1: Scan Users</h3>
      <button id="scanBtn">üîç Scan All Users</button>
      <div id="scanResults"></div>
    </div>
    
    <div class="section">
      <h3 style="color: #66fcf1;">Step 2: Repair Issues</h3>
      <button id="repairBtn" disabled>üîß Repair All Issues</button>
      <button id="repairCurrentBtn">üîß Repair My Profile Only</button>
    </div>
    
    <div class="log" id="log"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      doc, 
      getDoc, 
      setDoc, 
      getDocs,
      serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { firebaseConfig } from "./js/firebase-config.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    const logDiv = document.getElementById('log');
    const scanBtn = document.getElementById('scanBtn');
    const repairBtn = document.getElementById('repairBtn');
    const repairCurrentBtn = document.getElementById('repairCurrentBtn');
    const scanResults = document.getElementById('scanResults');
    
    let usersWithIssues = [];
    let currentUser = null;
    
    function log(message, type = 'info') {
      console.log(message);
      const div = document.createElement('div');
      div.className = type;
      div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(div);
      logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    async function scanUsers() {
      log('üîç Starting user scan...', 'info');
      scanBtn.disabled = true;
      scanResults.innerHTML = '<p style="color: #888;">Scanning...</p>';
      usersWithIssues = [];
      
      try {
        // Get all users from authentication (via users collection)
        const usersRef = collection(db, "users");
        const snapshot = await getDocs(usersRef);
        
        log(`Found ${snapshot.size} users in database`, 'info');
        
        for (const userDoc of snapshot.docs) {
          const userId = userDoc.id;
          const userData = userDoc.data();
          const email = userData.email || 'Unknown Email';
          
          log(`\n--- Checking user: ${userId} (${email}) ---`, 'info');
          
          const issues = [];
          let username = null;
          
          // Check parent document
          if (!userData.displayName) {
            issues.push('Missing displayName in parent doc');
          } else {
            username = userData.displayName;
          }
          
          // Check profile subcollection
          const profileRef = doc(db, "users", userId, "data", "profile");
          const profileSnap = await getDoc(profileRef);
          
          if (!profileSnap.exists()) {
            issues.push('Missing profile subcollection');
            log(`  ‚ùå Profile missing`, 'error');
          } else if (!profileSnap.data()?.username) {
            issues.push('Profile exists but username is empty');
            log(`  ‚ö†Ô∏è Profile exists but no username`, 'warning');
          } else {
            username = username || profileSnap.data().username;
            log(`  ‚úÖ Profile OK (username: ${profileSnap.data().username})`, 'success');
          }
          
          // Check leaderboard
          const leaderboardRef = doc(db, "leaderboard", userId);
          const leaderboardSnap = await getDoc(leaderboardRef);
          
          if (!leaderboardSnap.exists()) {
            issues.push('Missing from leaderboard');
            log(`  ‚ùå Not in leaderboard`, 'error');
          } else if (!leaderboardSnap.data()?.username) {
            issues.push('In leaderboard but no username');
            log(`  ‚ö†Ô∏è In leaderboard but no username`, 'warning');
          } else {
            log(`  ‚úÖ Leaderboard OK (username: ${leaderboardSnap.data().username})`, 'success');
          }
          
          if (issues.length > 0) {
            usersWithIssues.push({
              userId,
              email,
              username: username || email.split('@')[0],
              displayName: userData.displayName,
              issues
            });
            log(`  ‚ö†Ô∏è Found ${issues.length} issue(s)`, 'warning');
          } else {
            log(`  ‚úÖ User profile is complete`, 'success');
          }
        }
        
        // Display results
        if (usersWithIssues.length === 0) {
          scanResults.innerHTML = '<div class="user-card ok"><strong>‚úÖ All users have complete profiles!</strong></div>';
          log('\nüéâ All users are OK!', 'success');
          repairBtn.disabled = true;
        } else {
          scanResults.innerHTML = `
            <p style="color: #ff9800; font-weight: bold;">Found ${usersWithIssues.length} user(s) with issues:</p>
            ${usersWithIssues.map(user => `
              <div class="user-card missing">
                <strong>${user.email}</strong> (ID: ${user.userId.substring(0, 8)}...)<br>
                <small>Issues: ${user.issues.join(', ')}</small>
              </div>
            `).join('')}
          `;
          log(`\n‚ö†Ô∏è Found ${usersWithIssues.length} users with issues`, 'warning');
          repairBtn.disabled = false;
        }
        
      } catch (err) {
        log(`‚ùå Scan failed: ${err.message}`, 'error');
        console.error(err);
      }
      
      scanBtn.disabled = false;
    }
    
    async function repairUser(userId, email, username, displayName) {
      log(`\nüîß Repairing user: ${email}`, 'info');
      
      try {
        // Determine best username to use
        const finalUsername = username || displayName || email.split('@')[0];
        log(`  Using username: ${finalUsername}`, 'info');
        
        // 1. Update parent document
        await setDoc(doc(db, "users", userId), {
          uid: userId,
          email: email,
          displayName: finalUsername,
          createdAt: serverTimestamp()
        }, { merge: true });
        log(`  ‚úÖ Updated parent document`, 'success');
        
        // 2. Create/update profile
        await setDoc(doc(db, "users", userId, "data", "profile"), {
          username: finalUsername,
          email: email,
          createdAt: serverTimestamp()
        });
        log(`  ‚úÖ Created/updated profile`, 'success');
        
        // 3. Check/create stats
        const statsRef = doc(db, "users", userId, "data", "stats");
        const statsSnap = await getDoc(statsRef);
        if (!statsSnap.exists()) {
          await setDoc(statsRef, {
            xp: 0,
            streak: 0,
            hearts: 4,
            lastWorkoutDate: null,
            updatedAt: serverTimestamp()
          });
          log(`  ‚úÖ Created stats`, 'success');
        }
        
        // 4. Update leaderboard
        await setDoc(doc(db, "leaderboard", userId), {
          username: finalUsername,
          xp: statsSnap.exists() ? statsSnap.data().xp || 0 : 0,
          streak: statsSnap.exists() ? statsSnap.data().streak || 0 : 0,
          updatedAt: serverTimestamp()
        });
        log(`  ‚úÖ Updated leaderboard`, 'success');
        
        log(`  üéâ Successfully repaired ${email}`, 'success');
        return true;
        
      } catch (err) {
        log(`  ‚ùå Failed to repair: ${err.message}`, 'error');
        console.error(err);
        return false;
      }
    }
    
    async function repairAllUsers() {
      if (usersWithIssues.length === 0) {
        log('No users need repair', 'info');
        return;
      }
      
      repairBtn.disabled = true;
      log('\nüîß Starting repair of all users...', 'info');
      
      let successCount = 0;
      let failCount = 0;
      
      for (const user of usersWithIssues) {
        const success = await repairUser(user.userId, user.email, user.username, user.displayName);
        if (success) successCount++;
        else failCount++;
      }
      
      log(`\n‚úÖ Repair complete: ${successCount} fixed, ${failCount} failed`, successCount > 0 ? 'success' : 'error');
      
      // Rescan
      setTimeout(() => {
        log('\nüîÑ Rescanning to verify...', 'info');
        scanUsers();
      }, 1000);
    }
    
    async function repairCurrentUser() {
      if (!currentUser) {
        log('‚ùå Not logged in', 'error');
        return;
      }
      
      repairCurrentBtn.disabled = true;
      
      const email = currentUser.email;
      const displayName = currentUser.displayName || email.split('@')[0];
      
      await repairUser(currentUser.uid, email, displayName, displayName);
      
      repairCurrentBtn.disabled = false;
      
      log('\nüîÑ Rescanning current user...', 'info');
      setTimeout(() => scanUsers(), 1000);
    }
    
    scanBtn.addEventListener('click', scanUsers);
    repairBtn.addEventListener('click', repairAllUsers);
    repairCurrentBtn.addEventListener('click', repairCurrentUser);
    
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        log(`‚úÖ Logged in as: ${user.email}`, 'success');
        log(`Ready to scan users. Click "Scan All Users" to begin.`, 'info');
      } else {
        log('‚ö†Ô∏è Not logged in. Go to login.html first.', 'warning');
        scanBtn.disabled = true;
        repairCurrentBtn.disabled = true;
      }
    });
  </script>
</body>
</html>