<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üë• Friends - Gymify</title>
  <style>
    body {
      margin: 0;
      font-family: Poppins, sans-serif;
      background: #0d1117;
      color: #fff;
    }

    .container {
      max-width: 500px;
      margin: auto;
      padding: 15px;
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
    }

    .header h2 {
      color: #66fcf1;
      margin-bottom: 5px;
    }

    .header p {
      color: #c5c6c7;
      font-size: 14px;
    }

    .search-section {
      background: #161b22;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .search-box {
      display: flex;
      gap: 10px;
    }

    input {
      background: #2a2a2a;
      color: #fff;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 10px;
      font-size: 14px;
      outline: none;
      flex: 1;
    }

    input::placeholder {
      color: #666;
    }

    button {
      background: #238636;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 15px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }

    button:hover {
      background: #2ea043;
    }

    .btn-secondary {
      background: #444;
    }

    .btn-secondary:hover {
      background: #555;
    }

    .section {
      background: #161b22;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
    }

    .section h3 {
      color: #66fcf1;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .friend-card {
      background: #2a2a2a;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.3s;
    }

    .friend-card:hover {
      background: #333;
    }

    .friend-info {
      flex: 1;
    }

    .friend-name {
      font-weight: 600;
      color: #fff;
      margin-bottom: 3px;
    }

    .friend-stats {
      font-size: 13px;
      color: #c5c6c7;
    }

    .friend-actions {
      display: flex;
      gap: 8px;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 13px;
    }

    .btn-danger {
      background: #da3633;
    }

    .btn-danger:hover {
      background: #b93431;
    }

    .empty-state {
      text-align: center;
      padding: 30px 20px;
      color: #666;
    }

    .empty-state p {
      margin-bottom: 15px;
    }

    .pending-badge {
      background: #ff9800;
      color: #000;
      padding: 3px 8px;
      border-radius: 5px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }

    .back-btn {
      width: 100%;
      padding: 12px;
      background: #444;
      margin-top: 20px;
    }

    #status {
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
      display: none;
    }

    #status.show {
      display: block;
    }

    #status.success {
      background: #238636;
      color: white;
    }

    #status.error {
      background: #da3633;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h2>üë• Friends</h2>
      <p>Connect with workout buddies and compete together!</p>
    </header>

    <div id="status"></div>

    <!-- Suggested Users Section -->
    <div class="section">
      <h3>üí° Suggested Users</h3>
      <div id="suggestedUsers">
        <div class="empty-state">
          <p style="color: #666;">Loading suggestions...</p>
        </div>
      </div>
    </div>

    <!-- Search Section -->
    <div class="search-section">
      <h3 style="color: #66fcf1; margin-bottom: 10px;">üîç Find Friends</h3>
      <div class="search-box">
        <input 
          type="text" 
          id="searchInput" 
          placeholder="Search by username or email..."
        />
        <button id="searchBtn" class="btn-small">Search</button>
      </div>
      <div id="searchResults" style="margin-top: 15px;"></div>
    </div>

    <!-- Pending Requests -->
    <div class="section">
      <h3>üì¨ Friend Requests <span id="requestCount" class="pending-badge" style="display: none;">0</span></h3>
      <div id="pendingRequests">
        <div class="empty-state">
          <p>No pending friend requests</p>
        </div>
      </div>
    </div>

    <!-- Friends List -->
    <div class="section">
      <h3>‚úÖ My Friends (<span id="friendCount">0</span>)</h3>
      <div id="friendsList">
        <div class="empty-state">
          <p>You haven't added any friends yet</p>
          <p style="font-size: 13px;">Search above to find workout buddies!</p>
        </div>
      </div>
    </div>

    <button class="back-btn" onclick="window.location.href='dashboard.html'">
      ‚¨ÖÔ∏è Back to Dashboard
    </button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      doc, 
      getDoc, 
      setDoc, 
      getDocs,
      query,
      where,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { firebaseConfig } from "./js/firebase-config.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;

    function showStatus(message, type) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = `show ${type}`;
      setTimeout(() => status.classList.remove('show'), 3000);
    }

    // Helper function to get username from user ID
    async function getUsername(userId) {
      try {
        console.log("üîç Getting username for:", userId);
        
        // Step 1: Check leaderboard first (fastest)
        try {
          const leaderboardRef = doc(db, "leaderboard", userId);
          const leaderboardSnap = await getDoc(leaderboardRef);
          
          if (leaderboardSnap.exists() && leaderboardSnap.data()?.username) {
            console.log("‚úÖ Found username in leaderboard:", leaderboardSnap.data().username);
            return leaderboardSnap.data().username;
          }
        } catch (leaderboardErr) {
          console.log("‚ö†Ô∏è Leaderboard check failed, trying profile...");
        }
        
        // Step 2: Try profile subcollection
        try {
          const profileRef = doc(db, "users", userId, "data", "profile");
          const profileSnap = await getDoc(profileRef);
          
          if (profileSnap.exists() && profileSnap.data()?.username) {
            console.log("‚úÖ Found username in profile:", profileSnap.data().username);
            return profileSnap.data().username;
          }
        } catch (profileErr) {
          console.log("‚ö†Ô∏è Profile check failed, trying parent doc...");
        }
        
        // Step 3: Fallback to parent user document
        const userRef = doc(db, "users", userId);
        const userSnap = await getDoc(userRef);
        
        if (userSnap.exists()) {
          const userData = userSnap.data();
          console.log("üìÑ User document data:", userData);
          
          // Try displayName first
          if (userData.displayName) {
            console.log("‚úÖ Found displayName:", userData.displayName);
            return userData.displayName;
          }
          
          // Then try email (show full email as fallback)
          if (userData.email) {
            console.log("‚úÖ Using email as username:", userData.email);
            return userData.email; // Show full email
          }
        }
        
        // If everything fails, show helpful message
        console.error("‚ùå PROFILE MISSING for user:", userId);
        console.error("‚ö†Ô∏è This user's profile was not created during signup!");
        console.error("üí° Use the repair tool at repair.html to fix this");
        return `‚ö†Ô∏è Profile Missing - ${userId.substring(0, 8)}`; // Clear indication
        
      } catch (err) {
        console.error("‚ùå Error getting username:", err);
        return `Error: ${userId.substring(0, 8)}`;
      }
    }

    // Search for users
    document.getElementById('searchBtn').addEventListener('click', async () => {
      const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
      if (!searchTerm) return showStatus('Please enter a username or email', 'error');

      const resultsDiv = document.getElementById('searchResults');
      resultsDiv.innerHTML = '<p style="color: #666;">Searching...</p>';

      try {
        // Get all users from leaderboard collection (faster than scanning all user docs)
        const leaderboardRef = collection(db, "leaderboard");
        const snapshot = await getDocs(leaderboardRef);
        const results = [];

        snapshot.forEach(doc => {
          const userId = doc.id;
          const username = doc.data().username || "";
          const xp = doc.data().xp || 0;

          // Skip current user
          if (userId === currentUser.uid) return;

          // Search by username (case insensitive)
          if (username.toLowerCase().includes(searchTerm)) {
            results.push({ userId, username, xp });
          }
        });

        // If no results from leaderboard, fall back to searching user profiles
        if (results.length === 0) {
          const usersRef = collection(db, "users");
          const usersSnapshot = await getDocs(usersRef);

          for (const userDoc of usersSnapshot.docs) {
            const userId = userDoc.id;
            if (userId === currentUser.uid) continue;

            const username = await getUsername(userId);
            const statsRef = doc(db, "users", userId, "data", "stats");
            const statsSnap = await getDoc(statsRef);
            const xp = statsSnap.exists() ? statsSnap.data().xp || 0 : 0;

            if (username.toLowerCase().includes(searchTerm)) {
              results.push({ userId, username, xp });
            }
          }
        }

        if (results.length === 0) {
          resultsDiv.innerHTML = '<p style="color: #666;">No users found. Try a different search term.</p>';
          return;
        }

        resultsDiv.innerHTML = results.map(user => `
          <div class="friend-card">
            <div class="friend-info">
              <div class="friend-name">${user.username}</div>
              <div class="friend-stats">‚≠ê ${user.xp} XP</div>
            </div>
            <button class="btn-small" onclick="sendFriendRequest('${user.userId}', '${user.username}')">
              + Add
            </button>
          </div>
        `).join('');
      } catch (err) {
        console.error(err);
        showStatus('Error searching users', 'error');
      }
    });

    // Send friend request
    window.sendFriendRequest = async (friendId, friendName) => {
      try {
        const myUsername = await getUsername(currentUser.uid);
        
        const requestRef = doc(collection(db, "friendRequests"));
        await setDoc(requestRef, {
          from: currentUser.uid,
          to: friendId,
          fromName: myUsername,
          toName: friendName,
          status: "pending",
          timestamp: new Date().toISOString()
        });

        showStatus(`Friend request sent to ${friendName}!`, 'success');
      } catch (err) {
        console.error(err);
        showStatus('Error sending request', 'error');
      }
    };

    // Load pending requests
    async function loadPendingRequests() {
      const requestsDiv = document.getElementById('pendingRequests');
      
      try {
        const requestsRef = collection(db, "friendRequests");
        const q = query(requestsRef, where("to", "==", currentUser.uid), where("status", "==", "pending"));
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
          requestsDiv.innerHTML = '<div class="empty-state"><p>No pending friend requests</p></div>';
          document.getElementById('requestCount').style.display = 'none';
          return;
        }

        document.getElementById('requestCount').textContent = snapshot.size;
        document.getElementById('requestCount').style.display = 'inline-block';

        requestsDiv.innerHTML = snapshot.docs.map(doc => {
          const data = doc.data();
          return `
            <div class="friend-card">
              <div class="friend-info">
                <div class="friend-name">${data.fromName}</div>
                <div class="friend-stats">Wants to be friends</div>
              </div>
              <div class="friend-actions">
                <button class="btn-small" onclick="acceptRequest('${doc.id}', '${data.from}')">
                  ‚úì Accept
                </button>
                <button class="btn-small btn-danger" onclick="rejectRequest('${doc.id}')">
                  ‚úó Reject
                </button>
              </div>
            </div>
          `;
        }).join('');
      } catch (err) {
        console.error(err);
      }
    }

    // Accept friend request - FIXED VERSION
    window.acceptRequest = async (requestId, friendId) => {
      try {
        console.log("ü§ù Accepting friend request from:", friendId);
        
        // Get usernames using helper function
        const friendUsername = await getUsername(friendId);
        const myUsername = await getUsername(currentUser.uid);
        
        console.log("‚úÖ Friend username resolved to:", friendUsername);
        console.log("‚úÖ My username resolved to:", myUsername);
        
        // Get stats
        const friendStatsRef = doc(db, "users", friendId, "data", "stats");
        const friendStatsSnap = await getDoc(friendStatsRef);
        const friendXP = friendStatsSnap.exists() ? friendStatsSnap.data().xp || 0 : 0;
        const friendStreak = friendStatsSnap.exists() ? friendStatsSnap.data().streak || 0 : 0;

        const myStatsRef = doc(db, "users", currentUser.uid, "data", "stats");
        const myStatsSnap = await getDoc(myStatsRef);
        const myXP = myStatsSnap.exists() ? myStatsSnap.data().xp || 0 : 0;
        const myStreak = myStatsSnap.exists() ? myStatsSnap.data().streak || 0 : 0;

        // Prepare friend data objects
        const myFriendData = {
          friendId,
          username: friendUsername,
          xp: friendXP,
          streak: friendStreak,
          addedAt: new Date().toISOString()
        };
        
        const theirFriendData = {
          friendId: currentUser.uid,
          username: myUsername,
          xp: myXP,
          streak: myStreak,
          addedAt: new Date().toISOString()
        };
        
        console.log("üìù Storing in my friends list:", myFriendData);
        console.log("üìù Storing in their friends list:", theirFriendData);

        // Add to both users' friends lists WITH usernames
        await setDoc(doc(db, "users", currentUser.uid, "friends", friendId), myFriendData);
        console.log("‚úÖ Added to my friends list");
        
        await setDoc(doc(db, "users", friendId, "friends", currentUser.uid), theirFriendData);
        console.log("‚úÖ Added to their friends list");

        // Delete request
        await deleteDoc(doc(db, "friendRequests", requestId));
        console.log("‚úÖ Deleted friend request");
        
        showStatus(`You and ${friendUsername} are now friends!`, 'success');
        loadPendingRequests();
        loadFriends();
        loadSuggestedUsers();
      } catch (err) {
        console.error("‚ùå Error accepting request:", err);
        showStatus('Error accepting request: ' + err.message, 'error');
      }
    };

    // Reject friend request
    window.rejectRequest = async (requestId) => {
      try {
        await deleteDoc(doc(db, "friendRequests", requestId));
        showStatus('Friend request rejected', 'success');
        loadPendingRequests();
      } catch (err) {
        console.error(err);
        showStatus('Error rejecting request', 'error');
      }
    };

    // Load friends list - FIXED VERSION
    async function loadFriends() {
      const friendsDiv = document.getElementById('friendsList');
      
      try {
        const friendsRef = collection(db, "users", currentUser.uid, "friends");
        const snapshot = await getDocs(friendsRef);

        if (snapshot.empty) {
          friendsDiv.innerHTML = `
            <div class="empty-state">
              <p>You haven't added any friends yet</p>
              <p style="font-size: 13px;">Search above to find workout buddies!</p>
            </div>
          `;
          document.getElementById('friendCount').textContent = '0';
          return;
        }

        document.getElementById('friendCount').textContent = snapshot.size;

        const friendsData = [];
        for (const friendDoc of snapshot.docs) {
          const friendData = friendDoc.data();
          const friendId = friendData.friendId;
          
          console.log("üìã Friend document data:", friendData);
          
          // Try to use stored username first, then fallback to fetching
          let username = friendData.username || "Unknown";
          
          // If username is not stored or is "Unknown", try to fetch it
          if (!friendData.username || friendData.username === "Unknown") {
            console.log("‚ö†Ô∏è Username not stored, fetching for:", friendId);
            username = await getUsername(friendId);
            
            // Update the friend document with the fetched username
            try {
              await setDoc(doc(db, "users", currentUser.uid, "friends", friendId), {
                ...friendData,
                username: username
              });
              console.log("‚úÖ Updated friend document with username:", username);
            } catch (updateErr) {
              console.error("Failed to update friend username:", updateErr);
            }
          }
          
          // Get latest stats
          const statsRef = doc(db, "users", friendId, "data", "stats");
          const statsSnap = await getDoc(statsRef);

          friendsData.push({
            friendId,
            username,
            xp: statsSnap.exists() ? statsSnap.data().xp || 0 : 0,
            streak: statsSnap.exists() ? statsSnap.data().streak || 0 : 0
          });
        }

        friendsDiv.innerHTML = friendsData.map(friend => `
          <div class="friend-card" style="cursor: pointer;" onclick="viewFriend('${friend.friendId}')">
            <div class="friend-info">
              <div class="friend-name">${friend.username}</div>
              <div class="friend-stats">‚≠ê ${friend.xp} XP ‚Ä¢ üî• ${friend.streak} day streak</div>
            </div>
            <button class="btn-small btn-danger" onclick="event.stopPropagation(); removeFriend('${friend.friendId}', '${friend.username}')">
              Remove
            </button>
          </div>
        `).join('');
      } catch (err) {
        console.error("‚ùå Error loading friends:", err);
      }
    }

    // Remove friend
    window.removeFriend = async (friendId, friendName) => {
      if (!confirm(`Remove ${friendName} from friends?`)) return;

      try {
        await deleteDoc(doc(db, "users", currentUser.uid, "friends", friendId));
        await deleteDoc(doc(db, "users", friendId, "friends", currentUser.uid));
        
        showStatus('Friend removed', 'success');
        loadFriends();
        loadSuggestedUsers();
      } catch (err) {
        console.error(err);
        showStatus('Error removing friend', 'error');
      }
    };

    // View friend profile
    window.viewFriend = (friendId) => {
      window.location.href = `friend-profile.html?id=${friendId}`;
    };

    // Load suggested users
    async function loadSuggestedUsers() {
      const suggestedDiv = document.getElementById('suggestedUsers');
      
      try {
        // Get current friends list
        const friendsRef = collection(db, "users", currentUser.uid, "friends");
        const friendsSnap = await getDocs(friendsRef);
        const friendIds = new Set(friendsSnap.docs.map(d => d.data().friendId));

        // Get top users from leaderboard
        const leaderboardRef = collection(db, "leaderboard");
        const snapshot = await getDocs(leaderboardRef);
        
        const suggestions = [];
        snapshot.forEach(doc => {
          const userId = doc.id;
          // Skip if current user or already friends
          if (userId === currentUser.uid || friendIds.has(userId)) return;
          
          suggestions.push({
            userId,
            username: doc.data().username || "User",
            xp: doc.data().xp || 0,
            streak: doc.data().streak || 0
          });
        });

        // Sort by XP and take top 5
        suggestions.sort((a, b) => b.xp - a.xp);
        const topSuggestions = suggestions.slice(0, 5);

        if (topSuggestions.length === 0) {
          suggestedDiv.innerHTML = `
            <div class="empty-state">
              <p>No suggestions available</p>
              <p style="font-size: 13px;">Search for users above!</p>
            </div>
          `;
          return;
        }

        suggestedDiv.innerHTML = topSuggestions.map(user => `
          <div class="friend-card">
            <div class="friend-info">
              <div class="friend-name">${user.username}</div>
              <div class="friend-stats">‚≠ê ${user.xp} XP ‚Ä¢ üî• ${user.streak} streak</div>
            </div>
            <button class="btn-small" onclick="sendFriendRequest('${user.userId}', '${user.username}')">
              + Add
            </button>
          </div>
        `).join('');
      } catch (err) {
        console.error(err);
        suggestedDiv.innerHTML = '<div class="empty-state"><p>Failed to load suggestions</p></div>';
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      
      currentUser = user;
      loadSuggestedUsers();
      loadPendingRequests();
      loadFriends();
    });
  </script>
</body>
</html>